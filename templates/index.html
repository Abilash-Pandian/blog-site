<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blog Site</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <h1>Welcome to the Blog Site</h1>
    <p>Your username: <strong id="username"></strong></p>
    <textarea
      id="blog-content"
      placeholder="Write your blog here..."
    ></textarea>
    <br />
    <input type="file" id="blog-image" accept="image/*" />
    <button onclick="postBlog()">Post Blog</button>

    <h2>All Blogs</h2>
    <div id="blogs-container"></div>

    <script>
      const username = "{{ username }}";
      document.getElementById("username").textContent = username;

      async function postBlog() {
        const content = document.getElementById("blog-content").value;
        const image = document.getElementById("blog-image").files[0];

        let imageData = "";
        if (image) {
          const reader = new FileReader();
          reader.onloadend = () => {
            imageData = reader.result;
            sendBlog(content, imageData);
          };
          reader.readAsDataURL(image);
        } else {
          sendBlog(content, "");
        }
      }

      async function sendBlog(content, image) {
        const response = await fetch("/post_blog", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ author: username, content, image }),
        });
        const data = await response.json();
        if (data.status === "success") {
          alert("Blog posted!");
          fetchBlogs();
        } else {
          alert("Error posting blog.");
        }
      }

      async function fetchBlogs() {
        const response = await fetch("/get_blogs");
        const blogs = await response.json();

        const container = document.getElementById("blogs-container");
        container.innerHTML = "";

        for (const [id, blog] of Object.entries(blogs)) {
          const blogElement = document.createElement("div");
          blogElement.className = "blog";
          blogElement.innerHTML = `
                    <h3>${blog.author}</h3>
                    <p>${blog.content}</p>
                    ${
                      blog.image
                        ? `<img src="${blog.image}" alt="Blog Image" style="max-width: 200px;">`
                        : ""
                    }
                    <div class="replies"></div>
                    <textarea placeholder="Reply..." class="reply-box"></textarea>
                    <button onclick="postReply('${id}', this.previousElementSibling.value)">Reply</button>
                `;
          container.appendChild(blogElement);

          const repliesContainer = blogElement.querySelector(".replies");
          for (const reply of blog.replies) {
            const replyElement = document.createElement("div");
            replyElement.className = "reply";
            replyElement.innerHTML = `
                        <strong>${reply.author}</strong>: ${reply.content}
                    `;
            repliesContainer.appendChild(replyElement);
          }
        }
      }

      async function postReply(blogId, content) {
        const response = await fetch("/reply", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ blog_id: blogId, author: username, content }),
        });
        const data = await response.json();
        if (data.status === "success") {
          alert("Reply posted!");
          fetchBlogs();
        } else {
          alert("Error posting reply.");
        }
      }

      // Fetch blogs on page load
      fetchBlogs();
    </script>
  </body>
</html>
